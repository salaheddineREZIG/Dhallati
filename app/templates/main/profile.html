{% extends 'layout.html' %}

{% block title %}Profile - {{ user.name if user else 'Profile' }}{% endblock %}

{% block extras %}
<style>
  /* Theme-aware CSS variables */
  :root {
    --primary-color: #3b82f6;
    --primary-light: #60a5fa;
    --primary-dark: #1d4ed8;
    --primary-rgb: 59, 130, 246;
    --secondary-color: #f8f9fa;
    --background-color: #ffffff;
    --surface-color: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --border-color: #e2e8f0;
    --shadow-color: rgba(0, 0, 0, 0.08);
    --danger-color: #dc3545;
    --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
  }

  .dark-theme {
    --primary-color: #FFD700;
    --primary-light: #FFE55C;
    --primary-dark: #B8860B;
    --primary-rgb: 255, 215, 0;
    --secondary-color: #000000;
    --background-color: #0a0a0a;
    --surface-color: #111111;
    --text-primary: #f8f8f8;
    --text-secondary: #a0a0a0;
    --border-color: #333333;
    --shadow-color: rgba(0, 0, 0, 0.5);
    --danger-color: #dc3545;
    --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  }

  /* Profile specific styles with theme support */
  .profile-card { 
    border-radius: 16px; 
    overflow: hidden;
    background-color: var(--background-color);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    box-shadow: var(--card-shadow);
  }
  
  .profile-header { 
    background: linear-gradient(90deg, 
      rgba(var(--primary-rgb), 0.9), 
      rgba(var(--primary-rgb), 0.95));
    color: white;
  }

  .avatar { 
    width: 140px; 
    height: 140px; 
    object-fit: cover; 
    border-radius: 50%; 
    border: 4px solid rgba(255,255,255,0.9); 
  }

  .stat { 
    font-weight: 700; 
    font-size: 1.05rem;
    color: var(--text-primary);
  }

  .small-muted { 
    color: var(--text-secondary) !important; 
    font-size: 0.9rem; 
  }

  .action-btns .btn { 
    min-width: 140px; 
  }

  /* Fix for all cards */
  .card {
    background-color: var(--background-color);
    border-color: var(--border-color);
    color: var(--text-primary);
  }

  .card-title {
    color: var(--text-primary);
  }

  /* Fix for list group items */
  .list-group-item {
    background-color: var(--background-color);
    border-color: var(--border-color);
    color: var(--text-primary);
  }

  .list-group-item-action:hover {
    background-color: rgba(var(--primary-rgb), 0.1);
  }

  /* Fix for borders in dark theme */
  .border-end {
    border-color: var(--border-color) !important;
  }

  /* Fix for modal */
  .modal-content {
    background-color: var(--background-color);
    color: var(--text-primary);
    border-color: var(--border-color);
  }

  .modal-header {
    border-bottom-color: var(--border-color);
  }

  .modal-footer {
    border-top-color: var(--border-color);
  }

  /* Fix for dropdowns */
  .dropdown-menu {
    background-color: var(--background-color);
    border-color: var(--border-color);
  }

  .dropdown-item {
    color: var(--text-primary);
  }

  .dropdown-item:hover {
    background-color: rgba(var(--primary-rgb), 0.1);
  }

  .dropdown-header {
    background-color: rgba(var(--primary-rgb), 0.1);
    color: var(--text-primary);
  }

  /* Fix for text colors */
  .text-primary {
    color: var(--primary-color) !important;
  }

  .text-danger {
    color: var(--danger-color) !important;
  }

  .text-muted {
    color: var(--text-secondary) !important;
  }

  /* Fix for alerts */
  .alert {
    background-color: rgba(var(--primary-rgb), 0.1);
    border-color: rgba(var(--primary-rgb), 0.2);
    color: var(--text-primary);
  }

  .alert-success {
    background-color: rgba(40, 167, 69, 0.2);
    border-color: rgba(40, 167, 69, 0.3);
  }

  .alert-danger {
    background-color: rgba(220, 53, 69, 0.2);
    border-color: rgba(220, 53, 69, 0.3);
  }

  /* Fix for buttons */
  .btn-outline-primary {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }

  .btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: #000000;
    border-color: var(--primary-color);
  }

  .btn-outline-light {
    border-color: rgba(255, 255, 255, 0.5);
    color: rgba(255, 255, 255, 0.9);
  }

  .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  /* Fix for table-like structures */
  dt {
    color: var(--text-secondary);
  }

  dd {
    color: var(--text-primary);
  }

  /* Fix for badges */
  .badge {
    color: #ffffff;
  }

  /* Transitions for theme switching */
  .profile-card,
  .card,
  .list-group-item,
  .modal-content,
  .dropdown-menu,
  .alert {
    transition: background-color 0.3s ease, 
                border-color 0.3s ease, 
                color 0.3s ease;
  }

  @media (max-width: 575px) { 
    .avatar { 
      width: 110px; 
      height: 110px; 
    } 
  }

  /* Fix for notifications dropdown positioning */
  .notification-dropdown {
    right: 0 !important;
    left: auto !important;
    transform: translateX(0) !important;
    min-width: 350px;
    max-width: 350px;
    max-height: 400px;
    overflow-y: auto;
  }

  @media (max-width: 768px) {
    .notification-dropdown {
      position: fixed !important;
      top: 60px !important;
      right: 10px !important;
      left: 10px !important;
      min-width: calc(100vw - 20px) !important;
      max-width: calc(100vw - 20px) !important;
      margin: 0 !important;
    }
  }

  .dropdown-menu-end {
    right: 0 !important;
    left: auto !important;
  }

  #notificationList {
    max-height: 300px;
    overflow-y: auto;
  }

  .dropdown-item {
    white-space: normal !important;
    word-wrap: break-word !important;
  }
</style>
{% endblock %}

{% block navbar %}
<!-- Navbar - Using the same navbar as claims management page -->
<nav class="navbar navbar-expand-lg navbar-glass fixed-top">
    <div class="container">
        <!-- Brand with Logo -->
        <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('lost_and_found.lost_and_found_page') }}">
            <div class="position-relative">
                <i class="bi bi-search-heart fs-3 navbar-brand-glow"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge badge-pulse bg-danger" 
                      style="display: none;" id="notificationBadge">
                    0
                </span>
            </div>
            <span class="navbar-brand-glow fs-4 fw-bold">Dhallati</span>
        </a>
        
        <!-- Mobile Toggle -->
        <button class="navbar-toggler navbar-toggler-custom" type="button" data-bs-toggle="collapse" 
                data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" 
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <!-- Navbar Content -->
        <div class="collapse navbar-collapse" id="mainNavbar">
            <!-- Navigation Links -->
            <ul class="navbar-nav mx-auto">
            </ul>
            
            <!-- Right Side Actions -->
            <div class="d-flex align-items-center gap-3">
                <!-- Notifications Dropdown -->
                <div class="dropdown">
                    <a href="#" class="nav-link position-relative p-0" id="notificationDropdown" 
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-bell fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger badge-pulse" 
                              id="notificationCount" style="font-size: 0.6rem; display: none;">
                            0
                        </span>
                    </a>
                    
                    <ul class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
                        <li class="dropdown-header notification-header d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Notifications</span>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-light" id="markAllReadBtn">
                                    <i class="bi bi-check-all"></i>
                                </button>
                                <button class="btn btn-sm btn-light" id="refreshNotifications">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </li>
                        <div id="notificationList" class="py-2">
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-bell-slash fs-3 mb-2 d-block"></i>
                                <p class="mb-0">No notifications yet</p>
                                <small class="text-muted">We'll notify you when something happens</small>
                            </div>
                        </div>
                        <li class="dropdown-footer p-3 text-center border-top">
                            <a href="#" class="text-decoration-none small d-flex align-items-center justify-content-center gap-1">
                                <i class="bi bi-eye"></i>
                                View all notifications
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Profile Dropdown -->
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" 
                       id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        {% if user.profile_pic %}
                        <img src="{{ user.profile_pic }}" class="profile-avatar" alt="{{ user.name }}">
                        {% else %}
                        <div class="profile-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                            {{ user.name[0]|upper }}
                        </div>
                        {% endif %}
                        <span class="ms-2 d-none d-md-inline">{{ user.name }}</span>
                    </a>
                    
                    <ul class="dropdown-menu dropdown-menu-end profile-dropdown" aria-labelledby="profileDropdown">
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('main.profile') }}">
                                <i class="bi bi-person"></i>
                                <span>Profile</span>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-item d-flex align-items-center gap-2">
                            <i class="bi bi-gear"></i><a class="nav-link" href="{{ url_for('lost_and_found.claims_management') }}">Claims</a>
                        </li>
                        
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{{ url_for('auth.logout') }}" method="GET" class="mb-0">
                                <button type="submit" class="dropdown-item d-flex align-items-center gap-2 text-danger">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span>Logout</span>
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block main %}
<div class="main-content">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div id="profile-flash" class="mb-3"></div>

        <!-- Profile card -->
        <div class="card profile-card shadow-sm">
          <div class="card-body p-0">
            <div class="row g-0 align-items-center profile-header p-4">
              <div class="col-md-3 text-center">
                <img src="{{ user.profile_pic if user and user.profile_pic else url_for('static', filename='images/default-avatar.png') }}" alt="{{ user.name }}" class="avatar mb-2" id="profile-avatar">
                <div class="small-muted">Member since <strong>{{ user.created_at if user and user.get('created_at') else '—' }}</strong></div>
              </div>
              <div class="col-md-6 text-md-start text-center mt-3 mt-md-0">
                <h2 class="mb-1">{{ user.name if user else 'User Name' }}</h2>
                <p class="mb-1 small-muted">{{ user.email if user else 'email@example.com' }}</p>
              </div>
              <div class="col-md-3 text-md-end text-center mt-3 mt-md-0 action-btns">
                <a href="{{ url_for('lost_and_found.lost_and_found_page') }}" class="btn btn-outline-light me-2">Home</a>
              </div>
            </div>

            <div class="row g-0 p-4">
              <div class="col-md-4 border-end text-center">
                <div class="mb-2 small-muted">Reports submitted</div>
                <div class="stat">{{ stats.get('reports', [])|length }}</div>
              </div>
              <div class="col-md-4 border-end text-center">
                <div class="mb-2 small-muted">Items claimed</div>
                <div class="stat">{{ stats.get('items_claimed', 0) }}</div>
              </div>
              <div class="col-md-4 text-center">
                <div class="mb-2 small-muted">Active listings</div>
                <div class="stat">{{ stats.get('active_items', 0) }}</div>
              </div>
            </div>

          </div>
        </div>

        <!-- Main content: left column - recent reports, right column - actions / details -->
        <div class="row mt-4">
          <div class="col-lg-8">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Recent Reports</h5>
                <div id="reports-list" class="list-group list-group-flush">
                  <!-- items will be appended here by JS -->
                </div>

                <div id="reports-empty" class="text-center small-muted py-4" style="display:none;">
                  No recent reports.
                </div>

                <div class="text-center my-3">
                  <button id="reports-load-more" class="btn btn-outline-primary">Load more</button>
                </div>

                <div id="reports-spinner" class="text-center mt-2" style="display:none;">
                  <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Account Details</h5>
                <dl class="row mb-0">
                  <dt class="col-sm-4 small-muted">Full name</dt>
                  <dd class="col-sm-8">{{ user.name }}</dd>

                  <dt class="col-sm-4 small-muted">Email</dt>
                  <dd class="col-sm-8">{{ user.email }}</dd>
                  <dt class="col-sm-4 small-muted">Member ID</dt>
                  <dd class="col-sm-8">{{ user.id }}</dd>
                </dl>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
              <div class="card-body text-center">
                <h6>Quick Actions</h6>
                <div class="d-grid gap-2">
                  <a href="{{ url_for('lost_and_found.new_report') }}" class="btn btn-primary">Report an Item</a>
                  <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger">Logout</a>
                </div>
              </div>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <h6 class="card-title">Contact</h6>
                <p class="small-muted mb-1">If someone needs to reach you regarding a report, they will see your contact info as provided in each report (if not anonymous).</p>
                <p class="mb-0"><small class="text-muted">Email: </small> <br>{{ user.email }}</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editReportModal" tabindex="-1" aria-labelledby="editReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editReportModalLabel">Edit Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('lost_and_found.update_report') }}" enctype="multipart/form-data" id="edit-report-form">
        <input type="hidden" name="report_id" id="edit-report-id">
        <input type="hidden" name="_method" value="PUT">
        
        <div class="modal-body">
          <div id="edit-form-container">
            <!-- Form will be loaded here via AJAX -->
            <div class="text-center py-4">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const PAGE_SIZE = 4;
  const state = { page: 0, loading: false, finished: false };

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderReportItem(r) {
    const created = r.created_at || '';
    const id = escapeHtml(String(r.id));
    const itemId = encodeURIComponent(r.item_id || '');
    const deleteModalId = `deleteReportModal-${id}`;
    const deleteRoute = `/lost_and_found/api?report_id=${encodeURIComponent(id)}`;
    const location = r.location_reported || '—';

    return `
    <div class="report-item mb-3" id="report-${id}">
      <a href="/lost_and_found/item?id=${itemId}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-bold">${escapeHtml(r.item_name || 'Unnamed')}</div>
          <div class="small-muted">${escapeHtml(location)} • ${escapeHtml((r.report_type || '').charAt(0).toUpperCase() + (r.report_type || '').slice(1))} • ${escapeHtml(created)}</div>
        </div>
        <div class="text-end">
          ${r.status ? `<span class="badge bg-secondary">${escapeHtml(r.status)}</span>` : ''}
        </div>
      </a>

      <div class="d-flex justify-content-end p-2 gap-2">
        <button type="button" class="btn btn-outline-primary edit-report-btn" 
                data-report-id="${id}" data-bs-toggle="modal" data-bs-target="#editReportModal">
          Edit
        </button>

        <button type="button"
                class="btn btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#${deleteModalId}"
                data-route="${deleteRoute}"
                data-report-id="${id}">
          Delete
        </button>
      </div>

      <div class="modal fade" id="${deleteModalId}" tabindex="-1" aria-labelledby="${deleteModalId}Label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="${deleteModalId}Label">Confirm Deletion</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete the report for <strong>${escapeHtml(r.item_name || 'this item')}</strong>?
              This action cannot be undone.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button"
                      class="btn btn-danger confirm-delete-btn"
                      data-route="${deleteRoute}"
                      data-report-id="${id}"
                      data-bs-dismiss="modal">
                Yes, delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  }

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-report-btn')) {
      const reportId = e.target.getAttribute('data-report-id');
      loadEditForm(reportId);
    }
  });

  async function loadEditForm(reportId) {
    try {
      document.getElementById('edit-report-id').value = reportId;
      document.getElementById('editReportModalLabel').textContent = `Edit Report #${reportId}`;
      
      const response = await fetch(`/profile/get_edit_form/${reportId}`);
      if (!response.ok) throw new Error('Failed to load form');
      
      const formHtml = await response.text();
      document.getElementById('edit-form-container').innerHTML = formHtml;
      
    } catch (error) {
      console.error('Error loading edit form:', error);
      document.getElementById('edit-form-container').innerHTML = 
        '<div class="alert alert-danger">Error loading form. Please try again.</div>';
    }
  }

  document.getElementById('editReportModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('edit-form-container').innerHTML = 
      '<div class="text-center py-4"><div class="spinner-border" role="status"></div></div>';
  });

  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest && e.target.closest('.confirm-delete-btn');
    if (!btn) return;
    const route = btn.getAttribute('data-route') || '';
    const reportId = btn.getAttribute('data-report-id');

    if (!route) {
      console.warn(`Delete route is empty for report ${reportId}.`);
      showFlash('Delete route not configured', 'warning');
      return;
    }

    (async function () {
      try {
        const headers = { 'Accept': 'application/json' };
        const csrf = getCsrfToken();
        if (csrf) headers['X-CSRFToken'] = csrf;

        const res = await fetch(route, { method: 'DELETE', headers: headers, credentials: 'same-origin' });
        const payload = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = payload.message || `Failed to delete (status ${res.status})`;
          console.error(msg);
          showFlash(msg, 'danger');
          return;
        }

        const root = document.getElementById(`report-${reportId}`);
        if (root) root.remove();

        showFlash(payload.message || 'Report deleted', 'success');
      } catch (err) {
        console.error('Delete failed', err);
        showFlash('An error occurred while deleting the report', 'danger');
      }
    })();
  });

  function showFlash(message, level) {
    const flash = document.getElementById('profile-flash');
    if (!flash) {
      alert(message);
      return;
    }
    const cls = {
      success: 'alert-success',
      danger: 'alert-danger',
      warning: 'alert-warning',
      info: 'alert-info'
    }[level] || 'alert-secondary';

    flash.innerHTML = `<div class="alert ${cls} alert-dismissible" role="alert">
      ${escapeHtml(message)}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
  }

  async function loadReports() {
    if (state.loading || state.finished) return;
    state.loading = true;
    state.page += 1;

    const btn = document.getElementById('reports-load-more');
    const spinner = document.getElementById('reports-spinner');
    const empty = document.getElementById('reports-empty');

    if (btn) btn.disabled = true;
    if (spinner) spinner.style.display = 'block';

    const url = `/profile/reports?page=${state.page}&page_size=${PAGE_SIZE}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();

      const items = Array.isArray(data) ? data : (data.items || []);
      const container = document.getElementById('reports-list');

      if (state.page === 1 && items.length === 0) {
        if (empty) empty.style.display = 'block';
        if (btn) btn.style.display = 'none';
      } else {
        if (empty) empty.style.display = 'none';
        const frag = document.createDocumentFragment();
        items.forEach(it => {
          const wrapper = document.createElement('div');
          wrapper.innerHTML = renderReportItem(it);
          frag.appendChild(wrapper.firstElementChild);
        });
        container.appendChild(frag);
      }

      if (data.has_more === false) {
        state.finished = true;
      } else if (typeof data.total === 'number') {
        const loaded = (state.page - 1) * PAGE_SIZE + items.length;
        if (loaded >= data.total) state.finished = true;
      } else if (items.length < PAGE_SIZE) {
        state.finished = true;
      }

      if (state.finished && btn) btn.style.display = 'none';
      else if (btn) btn.style.display = 'inline-block';

    } catch (err) {
      console.error('Failed to load reports:', err);
    } finally {
      state.loading = false;
      if (btn) btn.disabled = false;
      if (spinner) spinner.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('reports-load-more');
    if (btn) btn.addEventListener('click', loadReports);
    loadReports();
  });

})();
</script>
{% endblock %}