{% extends 'layout.html' %}

{% block title %}Profile - {{ user.name if user else 'Profile' }}{% endblock %}

{% block extras %}
<style>
  /* Small custom tweaks */
  .profile-card { border-radius: 16px; overflow: hidden; }
  .profile-header { background: linear-gradient(90deg, rgba(2,6,23,0.9), rgba(45,55,72,0.95)); color: white; }
  .avatar { width: 140px; height: 140px; object-fit: cover; border-radius: 50%; border: 4px solid rgba(255,255,255,0.9); }
  .stat { font-weight: 700; font-size: 1.05rem; }
  .small-muted { color: #6c757d; font-size: 0.9rem; }
  .action-btns .btn { min-width: 140px; }
  @media (max-width: 575px) { .avatar { width: 110px; height: 110px; } }
</style>
{% endblock %}

{% block main %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div id="profile-flash" class="mb-3"></div>

      <!-- Profile card -->
      <div class="card profile-card shadow-sm">
        <div class="card-body p-0">
          <div class="row g-0 align-items-center profile-header p-4">
            <div class="col-md-3 text-center">
              <img src="{{ user.profile_pic if user and user.profile_pic else url_for('static', filename='images/default-avatar.png') }}" alt="{{ user.name }}" class="avatar mb-2" id="profile-avatar">
              <div class="small-muted">Member since <strong>{{ user.created_at if user and user.get('created_at') else '—' }}</strong></div>
            </div>
            <div class="col-md-6 text-md-start text-center mt-3 mt-md-0">
              <h2 class="mb-1">{{ user.name if user else 'User Name' }}</h2>
              <p class="mb-1 small-muted">{{ user.email if user else 'email@example.com' }}</p>
            </div>
            <div class="col-md-3 text-md-end text-center mt-3 mt-md-0 action-btns">
              <a href="{{ url_for('main.home') }}" class="btn btn-outline-light me-2">Home</a>
            </div>
          </div>

          <div class="row g-0 p-4">
            <div class="col-md-4 border-end text-center">
              <div class="mb-2 small-muted">Reports submitted</div>
              <div class="stat">{{ stats.get('reports', [])|length }}</div>
            </div>
            <div class="col-md-4 border-end text-center">
              <div class="mb-2 small-muted">Items claimed</div>
              <div class="stat">{{ stats.get('items_claimed', 0) }}</div>
            </div>
            <div class="col-md-4 text-center">
              <div class="mb-2 small-muted">Active listings</div>
              <div class="stat">{{ stats.get('active_items', 0) }}</div>
            </div>
          </div>

        </div>
      </div>

      <!-- Main content: left column - recent reports, right column - actions / details -->
      <div class="row mt-4">
        <div class="col-lg-8">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title">Recent Reports</h5>
              <div id="reports-list" class="list-group list-group-flush">
                  <!-- items will be appended here by JS -->
                </div>

                <div id="reports-empty" class="text-center small-muted py-4" style="display:none;">
                  No recent reports.
                </div>

                <div class="text-center my-3">
                  <button id="reports-load-more" class="btn btn-outline-primary">Load more</button>
                </div>

                <div id="reports-spinner" class="text-center mt-2" style="display:none;">
                  <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
                </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Account Details</h5>
              <dl class="row mb-0">
                <dt class="col-sm-4 small-muted">Full name</dt>
                <dd class="col-sm-8">{{ user.name }}</dd>

                <dt class="col-sm-4 small-muted">Email</dt>
                <dd class="col-sm-8">{{ user.email }}</dd>
                <dt class="col-sm-4 small-muted">Member ID</dt>
                <dd class="col-sm-8">{{ user.id }}</dd>
              </dl>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm mb-3">
            <div class="card-body text-center">
              <h6>Quick Actions</h6>
              <div class="d-grid gap-2">
                <a href="{{ url_for('lost_and_found.new_report') }}" class="btn btn-primary">Report an Item</a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger">Logout</a>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="card-title">Contact</h6>
              <p class="small-muted mb-1">If someone needs to reach you regarding a report, they will see your contact info as provided in each report (if not anonymous).</p>
              <p class="mb-0"><small class="text-muted">Email: </small> <br>{{ user.email }}</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="editReportModal" tabindex="-1" aria-labelledby="editReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editReportModalLabel">Edit Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('lost_and_found.update_report') }}" enctype="multipart/form-data" id="edit-report-form">
        <input type="hidden" name="report_id" id="edit-report-id">
        <input type="hidden" name="_method" value="PUT">
        
        <div class="modal-body">
          <div id="edit-form-container">
            <!-- Form will be loaded here via AJAX -->
            <div class="text-center py-4">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>




{% endblock %}

{% block scripts %}
<script>
(function () {
  const PAGE_SIZE = 6; // change as you like
  const state = { page: 0, loading: false, finished: false };

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderReportItem(r) {
  const created = r.created_at || '';
  const badge = r.status ? `<span class="badge bg-secondary">${escapeHtml(r.status)}</span>` : '';
  const id = escapeHtml(String(r.id));
  const itemId = encodeURIComponent(r.item_id || '');
  const deleteModalId = `deleteReportModal-${id}`;
  const deleteRoute = `/lost_and_found/api?report_id=${encodeURIComponent(id)}`;

  return `
    <div class="report-item mb-3" id="report-${id}">
      <a href="/lost_and_found/item?id=${itemId}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-bold">${escapeHtml(r.item_name || 'Unnamed')}</div>
          <div class="small-muted">${escapeHtml(r.location_reported || '—')} • ${escapeHtml((r.report_type || '').charAt(0).toUpperCase() + (r.report_type || '').slice(1))} • ${escapeHtml(created)}</div>
        </div>
        <div class="text-end">
          ${badge}
        </div>
      </a>

      <div class="d-flex justify-content-end p-2 gap-2">
        <!-- Simplified Edit button using shared modal -->
        <button type="button" class="btn btn-outline-primary edit-report-btn" 
                data-report-id="${id}" data-bs-toggle="modal" data-bs-target="#editReportModal">
          Edit
        </button>

        <button type="button"
                class="btn btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#${deleteModalId}"
                data-route="${deleteRoute}"
                data-report-id="${id}">
          Delete
        </button>
      </div>

      <!-- DELETE MODAL (keep existing) -->
      <div class="modal fade" id="${deleteModalId}" tabindex="-1" aria-labelledby="${deleteModalId}Label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="${deleteModalId}Label">Confirm Deletion</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete the report for <strong>${escapeHtml(r.item_name || 'this item')}</strong>?
              This action cannot be undone.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button"
                      class="btn btn-danger confirm-delete-btn"
                      data-route="${deleteRoute}"
                      data-report-id="${id}"
                      data-bs-dismiss="modal">
                Yes, delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Simple edit form handling
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('edit-report-btn')) {
    const reportId = e.target.getAttribute('data-report-id');
    loadEditForm(reportId);
  }
});

async function loadEditForm(reportId) {
  try {
    // Set the report ID in the form
    document.getElementById('edit-report-id').value = reportId;
    
    // Update modal title
    document.getElementById('editReportModalLabel').textContent = `Edit Report #${reportId}`;
    
    // Load the form content from server
    const response = await fetch(`/profile/get_edit_form/${reportId}`);
    if (!response.ok) throw new Error('Failed to load form');
    
    const formHtml = await response.text();
    document.getElementById('edit-form-container').innerHTML = formHtml;
    
  } catch (error) {
    console.error('Error loading edit form:', error);
    document.getElementById('edit-form-container').innerHTML = 
      '<div class="alert alert-danger">Error loading form. Please try again.</div>';
  }
}

// Clear form when modal is hidden
document.getElementById('editReportModal').addEventListener('hidden.bs.modal', function() {
  document.getElementById('edit-form-container').innerHTML = 
    '<div class="text-center py-4"><div class="spinner-border" role="status"></div></div>';
});

  // helper to get CSRF token from meta tag or cookie (if you use one)
  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    // fallback: cookie named csrf_token
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  // delegate click handler for delete confirmation
  document.addEventListener('click', function (e) {
    const btn = e.target.closest && e.target.closest('.confirm-delete-btn');
    if (!btn) return;
    const route = btn.getAttribute('data-route') || '';
    const reportId = btn.getAttribute('data-report-id');

    if (!route) {
      console.warn(`Delete route is empty for report ${reportId}.`);
      showFlash('Delete route not configured', 'warning');
      return;
    }

    // Perform DELETE via fetch
    (async function () {
      try {
        const headers = { 'Accept': 'application/json' };
        const csrf = getCsrfToken();
        if (csrf) headers['X-CSRFToken'] = csrf;

        const res = await fetch(route, { method: 'DELETE', headers: headers, credentials: 'same-origin' });
        const payload = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = payload.message || `Failed to delete (status ${res.status})`;
          console.error(msg);
          showFlash(msg, 'danger');
          return;
        }

        // success
        const root = document.getElementById(`report-${reportId}`);
        if (root) root.remove();

        showFlash(payload.message || 'Report deleted', 'success');
      } catch (err) {
        console.error('Delete failed', err);
        showFlash('An error occurred while deleting the report', 'danger');
      }
    })();
  });

  // small helper to show an inline flash (uses #profile-flash)
  function showFlash(message, level) {
    const flash = document.getElementById('profile-flash');
    if (!flash) {
      alert(message);
      return;
    }
    const cls = {
      success: 'alert-success',
      danger: 'alert-danger',
      warning: 'alert-warning',
      info: 'alert-info'
    }[level] || 'alert-secondary';

    flash.innerHTML = `<div class="alert ${cls} alert-dismissible" role="alert">
      ${escapeHtml(message)}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
  }


document.addEventListener('click', function (e) {
  const btn = e.target.closest && e.target.closest('.confirm-delete-btn');
  if (!btn) return;
  const route = btn.getAttribute('data-route') || '';
  const reportId = btn.getAttribute('data-report-id');

  if (!route) {
    console.warn(`Delete route is empty for report ${reportId}. Fill the data-route attribute to enable deletion.`);
    return;
  }

});

  async function loadReports() {
    if (state.loading || state.finished) return;
    state.loading = true;
    state.page += 1;

    const btn = document.getElementById('reports-load-more');
    const spinner = document.getElementById('reports-spinner');
    const empty = document.getElementById('reports-empty');

    if (btn) btn.disabled = true;
    if (spinner) spinner.style.display = 'block';

    const url = `/profile/reports?page=${state.page}&page_size=${PAGE_SIZE}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();

      const items = Array.isArray(data) ? data : (data.items || []);
      const container = document.getElementById('reports-list');

      if (state.page === 1 && items.length === 0) {
        // no reports at all
        if (empty) empty.style.display = 'block';
        if (btn) btn.style.display = 'none';
      } else {
        if (empty) empty.style.display = 'none';
        const frag = document.createDocumentFragment();
        items.forEach(it => {
          const wrapper = document.createElement('div');
          wrapper.innerHTML = renderReportItem(it);
          frag.appendChild(wrapper.firstElementChild);
        });
        container.appendChild(frag);
      }

      // decide finished
      if (data.has_more === false) {
        state.finished = true;
      } else if (typeof data.total === 'number') {
        const loaded = (state.page - 1) * PAGE_SIZE + items.length;
        if (loaded >= data.total) state.finished = true;
      } else if (items.length < PAGE_SIZE) {
        state.finished = true;
      }

      if (state.finished && btn) btn.style.display = 'none';
      else if (btn) btn.style.display = 'inline-block';

    } catch (err) {
      console.error('Failed to load reports:', err);
      // Optionally show user-facing toast/flash here
    } finally {
      state.loading = false;
      if (btn) btn.disabled = false;
      if (spinner) spinner.style.display = 'none';
    }
  }

  // wire up
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('reports-load-more');
    if (btn) btn.addEventListener('click', loadReports);

    // optionally load first page automatically
    loadReports();
  });

})();
</script>
{% endblock %}
