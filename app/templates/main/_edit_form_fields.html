{{ form.hidden_tag() }}

<!-- Display form errors -->
{% if form.errors %}
<div class="alert alert-danger">
    <ul class="mb-0">
    {% for field, errors in form.errors.items() %}
        {% for error in errors %}
            <li>{{ error }}</li>
        {% endfor %}
    {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Report Type -->
<div class="mb-3">
    <label class="form-label">Report Type</label>
    <div>
        {% for subfield in form.report_type %}
            <div class="form-check form-check-inline">
                {{ subfield(class="form-check-input") }}
                {{ subfield.label(class="form-check-label") }}
            </div>
        {% endfor %}
    </div>
</div>

<!-- Anonymous Switch -->
<div class="form-check form-switch mb-3">
    {{ form.is_anonymous(class="form-check-input") }}
    {{ form.is_anonymous.label(class="form-check-label") }}
</div>

<!-- Item Name -->
<div class="mb-3">
    {{ form.name.label(class="form-label") }}
    {{ form.name(class="form-control") }}
    {% if form.name.errors %}
        <div class="text-danger small">
            {% for error in form.name.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Description -->
<div class="mb-3">
    {{ form.description.label(class="form-label") }}
    {{ form.description(class="form-control", rows="3") }}
</div>

<!-- Category -->
<div class="mb-3">
    {{ form.category_id.label(class="form-label") }}
    {{ form.category_id(class="form-select") }}
    {% if form.category_id.errors %}
        <div class="text-danger small">
            {% for error in form.category_id.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<div class="mb-3">
    <label class="form-label">Location</label>
    {{ form.location_id(class="form-select") }}
</div>

<div class="mb-3">
    <label class="form-label">Specific Spot</label>
    {{ form.specific_spot(class="form-control") }}
</div>

<!-- Event DateTime -->
<div class="mb-3">
    {{ form.event_datetime.label(class="form-label") }}
    <input type="datetime-local" class="form-control" 
        id="{{ form.event_datetime.id }}" 
        name="{{ form.event_datetime.name }}" 
        value="{{ form.event_datetime.data.strftime('%Y-%m-%dT%H:%M') if form.event_datetime.data else '' }}">
</div>

<!-- Verification Question - ALWAYS SHOWN BUT CONDITIONALLY DISABLED -->
<div class="mb-3" id="verification-question-container">
    {{ form.verification_question.label(class="form-label") }}
    {{ form.verification_question(class="form-control", rows="3", 
       placeholder=("Required for found items - helps verify the real owner" if report.report_type == 'found' else "Only for found items")) }}
    <div class="form-text" id="verification-help-text">
        {% if report.report_type == 'found' %}
        Required for found items - helps verify the real owner
        {% else %}
        Only for found items - field will be disabled for lost reports
        {% endif %}
    </div>
    {% if form.verification_question.errors %}
        <div class="text-danger small">
            {% for error in form.verification_question.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Existing Images -->
<div class="mb-3">
    <label class="form-label">Current Images</label>
    <div class="existing-images">
        {% if report and report.item.images %}
            {% for image in report.item.images %}
                <div class="existing-image d-inline-block me-2 mb-2 text-center">
                    {% set url = image.image_url|replace('app\\','')|replace('\\','/') %}
                    <img src="{{ url if url.startswith('/') else '/' ~ url }}" alt="Current image" 
                         style="width: 100px; height: 100px; object-fit: cover;" 
                         class="rounded border">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" 
                               name="remove_images" value="{{ image.id }}" 
                               id="remove-image-{{ image.id }}">
                        <label class="form-check-label small" for="remove-image-{{ image.id }}">
                            Remove
                        </label>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No images uploaded</p>
        {% endif %}
    </div>
</div>

<!-- New Images -->
<div class="mb-3">
    {{ form.images.label(class="form-label") }}
    {{ form.images(class="form-control") }}
    <div class="form-text">Select new images to add to existing ones</div>
    {% if form.images.errors %}
        <div class="text-danger small">
            {% for error in form.images.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Additional Details -->
<div class="mb-3">
    {{ form.additional_details.label(class="form-label") }}
    {{ form.additional_details(class="form-control", rows="3") }}
</div>

<!-- Contact Info -->
<div class="mb-3">
    {{ form.contact_info.label(class="form-label") }}
    {{ form.contact_info(class="form-control") }}
    {% if form.contact_info.errors %}
        <div class="text-danger small">
            {% for error in form.contact_info.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
    <div class="form-text">10-digit phone number starting with 0</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const reportTypeRadios = document.querySelectorAll('input[name="report_type"]');
    const verificationQuestion = document.getElementById('{{ form.verification_question.id }}');
    const verificationContainer = document.getElementById('verification-question-container');
    const verificationHelpText = document.getElementById('verification-help-text');
    
    // Function to toggle verification question field
    function toggleVerificationQuestion() {
        const selectedReportType = document.querySelector('input[name="report_type"]:checked');
        
        if (selectedReportType && selectedReportType.value === 'found') {
            // Enable for found items
            verificationQuestion.disabled = false;
            verificationQuestion.placeholder = "Required for found items - helps verify the real owner";
            verificationQuestion.removeAttribute('readonly');
            verificationContainer.classList.remove('text-muted');
            verificationHelpText.textContent = "Required for found items - helps verify the real owner";
            verificationHelpText.classList.remove('text-muted');
        } else {
            // Disable for lost items
            verificationQuestion.disabled = true;
            verificationQuestion.value = ''; // Clear the value
            verificationQuestion.placeholder = "Only for found items - field disabled for lost reports";
            verificationContainer.classList.add('text-muted');
            verificationHelpText.textContent = "Only for found items - field disabled for lost reports";
            verificationHelpText.classList.add('text-muted');
        }
    }
    
    // Add event listeners to report type radio buttons
    reportTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleVerificationQuestion);
    });
    
    // Initialize on page load
    toggleVerificationQuestion();
    
    // Optional: Add styling for disabled state
    const style = document.createElement('style');
    style.textContent = `
        #verification-question-container.text-muted .form-label {
            color: #6c757d !important;
        }
        #{{ form.verification_question.id }}:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }
    `;
    document.head.appendChild(style);
});
</script>