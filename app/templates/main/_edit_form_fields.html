{{ form.hidden_tag() }}

<!-- Display form errors -->
{% if form.errors %}
<div class="alert alert-danger">
    <ul class="mb-0">
    {% for field, errors in form.errors.items() %}
        {% for error in errors %}
            <li>{{ error }}</li>
        {% endfor %}
    {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Display current report type as read-only -->
<div class="mb-3">
    <label class="form-label">Report Type</label>
    <div class="form-control-plaintext">
        <span class="badge {% if report.report_type == 'lost' %}bg-warning{% else %}bg-success{% endif %}">
            {{ report.report_type|title }}
        </span>
        <input type="hidden" name="report_type" value="{{ report.report_type }}">
    </div>
    <div class="form-text text-muted">Report type cannot be changed</div>
</div>

<!-- Anonymous Switch - Disabled for lost reports -->
<div class="form-check form-switch mb-3">
    {% if report.report_type == 'lost' %}
        {{ form.is_anonymous(class="form-check-input", disabled=true) }}
        <div class="form-text text-muted">Anonymous reporting is not available for lost items</div>
    {% else %}
        {{ form.is_anonymous(class="form-check-input") }}
    {% endif %}
    {{ form.is_anonymous.label(class="form-check-label") }}
</div>

<!-- Item Name -->
<div class="mb-3">
    {{ form.name.label(class="form-label") }}
    {{ form.name(class="form-control") }}
    {% if form.name.errors %}
        <div class="text-danger small">
            {% for error in form.name.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Description -->
<div class="mb-3">
    {{ form.description.label(class="form-label") }}
    {{ form.description(class="form-control", rows="3") }}
</div>

<!-- Category -->
<div class="mb-3">
    {{ form.category_id.label(class="form-label") }}
    {{ form.category_id(class="form-select") }}
    {% if form.category_id.errors %}
        <div class="text-danger small">
            {% for error in form.category_id.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<div class="mb-3">
    <label class="form-label">Location</label>
    {{ form.location_id(class="form-select") }}
</div>

<div class="mb-3">
    <label class="form-label">Specific Spot</label>
    {{ form.specific_spot(class="form-control") }}
</div>

<!-- Event DateTime -->
<div class="mb-3">
    {{ form.event_datetime.label(class="form-label") }}
    <input type="datetime-local" class="form-control" 
        id="{{ form.event_datetime.id }}" 
        name="{{ form.event_datetime.name }}" 
        value="{{ form.event_datetime.data.strftime('%Y-%m-%dT%H:%M') if form.event_datetime.data else '' }}">
</div>

<!-- Verification Question - Only for found reports -->
<div class="mb-3" id="verification-question-container">
    {{ form.verification_question.label(class="form-label") }}
    {% if report.report_type == 'lost' %}
        {{ form.verification_question(class="form-control", rows="3", disabled=true, readonly=true) }}
        <div class="form-text text-muted">Only for found items - field disabled for lost reports</div>
    {% else %}
        {{ form.verification_question(class="form-control", rows="3", 
           placeholder="Required for found items - helps verify the real owner") }}
        <div class="form-text">Required for found items - helps verify the real owner</div>
    {% endif %}
    {% if form.verification_question.errors %}
        <div class="text-danger small">
            {% for error in form.verification_question.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Existing Images -->
<div class="mb-3">
    <label class="form-label">Current Images</label>
    <div class="existing-images">
        {% if report and report.item.images %}
            {% for image in report.item.images %}
                <div class="existing-image d-inline-block me-2 mb-2 text-center">
                    {% set url = image.image_url|replace('app\\','')|replace('\\','/') %}
                    <img src="{{ url if url.startswith('/') else '/' ~ url }}" alt="Current image" 
                         style="width: 100px; height: 100px; object-fit: cover;" 
                         class="rounded border">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" 
                               name="remove_images" value="{{ image.id }}" 
                               id="remove-image-{{ image.id }}">
                        <label class="form-check-label small" for="remove-image-{{ image.id }}">
                            Remove
                        </label>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No images uploaded</p>
        {% endif %}
    </div>
</div>

<!-- New Images -->
<div class="mb-3">
    {{ form.images.label(class="form-label") }}
    {{ form.images(class="form-control") }}
    <div class="form-text">Select new images to add to existing ones (max 5 total)</div>
    {% if form.images.errors %}
        <div class="text-danger small">
            {% for error in form.images.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Additional Details -->
<div class="mb-3">
    {{ form.additional_details.label(class="form-label") }}
    {{ form.additional_details(class="form-control", rows="3") }}
</div>

<!-- Contact Info -->
<div class="mb-3">
    {{ form.contact_info.label(class="form-label") }}
    {{ form.contact_info(class="form-control") }}
    {% if form.contact_info.errors %}
        <div class="text-danger small">
            {% for error in form.contact_info.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
    <div class="form-text">10-digit phone number starting with 0</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const anonymousSwitch = document.getElementById('{{ form.is_anonymous.id }}');
    const contactInfoField = document.getElementById('{{ form.contact_info.id }}');
    
    // Function to toggle contact info field based on anonymity
    function toggleContactInfoField() {
        if (contactInfoField && anonymousSwitch) {
            if (anonymousSwitch.checked && "{{ report.report_type }}" === 'found') {
                // For found reports, if anonymous, contact info should be readonly
                contactInfoField.setAttribute('readonly', true);
                contactInfoField.style.backgroundColor = '#f8f9fa';
            } else {
                // Otherwise, make it editable
                contactInfoField.removeAttribute('readonly');
                contactInfoField.style.backgroundColor = '';
            }
        }
    }
    
    // Add event listener to anonymous switch
    if (anonymousSwitch) {
        anonymousSwitch.addEventListener('change', toggleContactInfoField);
    }
    
    // Initialize on page load
    toggleContactInfoField();
    
    // Add custom styling for disabled state
    const style = document.createElement('style');
    style.textContent = `
        #{{ form.verification_question.id }}:disabled,
        #{{ form.is_anonymous.id }}:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #{{ form.contact_info.id }}[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
    `;
    document.head.appendChild(style);
});
</script>