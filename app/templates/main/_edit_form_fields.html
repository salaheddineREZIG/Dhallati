{{ form.hidden_tag() }}

<!-- Display form errors -->
{% if form.errors %}
<div class="alert alert-danger">
    <ul class="mb-0">
    {% for field, errors in form.errors.items() %}
        {% for error in errors %}
            <li>{{ error }}</li>
        {% endfor %}
    {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Display current report type as read-only -->
<div class="mb-3">
    <label class="form-label">Report Type</label>
    <div class="form-control-plaintext">
        <span class="badge {% if report.report_type == 'lost' %}bg-warning{% else %}bg-success{% endif %}">
            {{ report.report_type|title }}
        </span>
        <input type="hidden" name="report_type" value="{{ report.report_type }}">
    </div>
    <div class="form-text text-muted">Report type cannot be changed</div>
</div>

<!-- Anonymous Switch - Disabled for lost reports -->
<div class="form-check form-switch mb-3">
    {% if report.report_type == 'lost' %}
        {{ form.is_anonymous(class="form-check-input", disabled=true) }}
        <div class="form-text text-muted">Anonymous reporting is not available for lost items</div>
    {% else %}
        {{ form.is_anonymous(class="form-check-input") }}
    {% endif %}
    {{ form.is_anonymous.label(class="form-check-label") }}
</div>

<!-- Item Name -->
<div class="mb-3">
    {{ form.name.label(class="form-label") }}
    {{ form.name(class="form-control") }}
    {% if form.name.errors %}
        <div class="text-danger small">
            {% for error in form.name.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Description -->
<div class="mb-3">
    {{ form.description.label(class="form-label") }}
    {{ form.description(class="form-control", rows="3") }}
</div>

<!-- Category -->
<div class="mb-3">
    {{ form.category_id.label(class="form-label") }}
    {{ form.category_id(class="form-select") }}
    {% if form.category_id.errors %}
        <div class="text-danger small">
            {% for error in form.category_id.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<div class="mb-3">
    <label class="form-label">Location</label>
    {{ form.location_id(class="form-select") }}
</div>

<div class="mb-3">
    <label class="form-label">Specific Spot</label>
    {{ form.specific_spot(class="form-control") }}
</div>

<!-- Event DateTime -->
<div class="mb-3">
    {{ form.event_datetime.label(class="form-label") }}
    <input type="datetime-local" class="form-control" 
        id="{{ form.event_datetime.id }}" 
        name="{{ form.event_datetime.name }}" 
        value="{{ form.event_datetime.data.strftime('%Y-%m-%dT%H:%M') if form.event_datetime.data else '' }}">
</div>

<!-- Verification Question - Only for found reports -->
<div class="mb-3" id="verification-question-container">
    {{ form.verification_question.label(class="form-label") }}
    {% if report.report_type == 'lost' %}
        {{ form.verification_question(class="form-control", rows="3", disabled=true, readonly=true) }}
        <div class="form-text text-muted">Only for found items - field disabled for lost reports</div>
    {% else %}
        {{ form.verification_question(class="form-control", rows="3", 
           placeholder="Required for found items - helps verify the real owner") }}
        <div class="form-text">Required for found items - helps verify the real owner</div>
    {% endif %}
    {% if form.verification_question.errors %}
        <div class="text-danger small">
            {% for error in form.verification_question.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Existing Images -->
<div class="mb-3">
    <label class="form-label">Current Images</label>
    <div class="existing-images">
        {% if report and report.item.images %}
            {% for image in report.item.images %}
                <div class="existing-image d-inline-block me-2 mb-2 text-center">
                    {% set url = image.image_url|replace('app\\','')|replace('\\','/') %}
                    <img src="{{ url if url.startswith('/') else '/' ~ url }}" alt="Current image" 
                         style="width: 100px; height: 100px; object-fit: cover;" 
                         class="rounded border">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" 
                               name="remove_images" value="{{ image.id }}" 
                               id="remove-image-{{ image.id }}">
                        <label class="form-check-label small" for="remove-image-{{ image.id }}">
                            Remove
                        </label>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No images uploaded</p>
        {% endif %}
    </div>
</div>

<!-- New Images -->
<div class="mb-3">
    {{ form.images.label(class="form-label") }}
    {{ form.images(class="form-control") }}
    <div class="form-text">Select new images to add to existing ones (max 5 total)</div>
    {% if form.images.errors %}
        <div class="text-danger small">
            {% for error in form.images.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Additional Details -->
<div class="mb-3">
    {{ form.additional_details.label(class="form-label") }}
    {{ form.additional_details(class="form-control", rows="3") }}
</div>

<!-- Contact Info -->
<div class="mb-3">
    {{ form.contact_info.label(class="form-label") }}
    {{ form.contact_info(class="form-control") }}
    {% if form.contact_info.errors %}
        <div class="text-danger small">
            {% for error in form.contact_info.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
    <div class="form-text">10-digit phone number starting with 0</div>
</div>

<style>
/* Theme-aware styles for the form */
:root {
    --primary-color: #3b82f6;
    --primary-light: #60a5fa;
    --primary-dark: #1d4ed8;
    --primary-rgb: 59, 130, 246;
    --secondary-color: #f8f9fa;
    --background-color: #ffffff;
    --surface-color: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --border-color: #e2e8f0;
    --danger-color: #dc3545;
}

.dark-theme {
    --primary-color: #FFD700;
    --primary-light: #FFE55C;
    --primary-dark: #B8860B;
    --primary-rgb: 255, 215, 0;
    --secondary-color: #000000;
    --background-color: #0a0a0a;
    --surface-color: #111111;
    --text-primary: #f8f8f8;
    --text-secondary: #a0a0a0;
    --border-color: #333333;
    --danger-color: #dc3545;
}

/* Fix form controls */
.form-control,
.form-select,
.form-check-input,
input[type="datetime-local"] {
    background-color: var(--background-color) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}

.form-control:focus,
.form-select:focus,
input[type="datetime-local"]:focus {
    background-color: var(--background-color) !important;
    border-color: var(--primary-color) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 0 0 0.25rem rgba(var(--primary-rgb), 0.25) !important;
}

.form-control:disabled,
.form-control[readonly],
.form-select:disabled,
.form-check-input:disabled,
input[type="datetime-local"]:disabled {
    background-color: var(--surface-color) !important;
    opacity: 0.7 !important;
    cursor: not-allowed !important;
}

/* Fix form labels */
.form-label {
    color: var(--text-primary) !important;
    font-weight: 500;
}

.form-check-label {
    color: var(--text-primary) !important;
}

/* Fix form text */
.form-text {
    color: var(--text-secondary) !important;
}

/* Fix alert */
.alert {
    background-color: rgba(var(--primary-rgb), 0.1);
    border-color: rgba(var(--primary-rgb), 0.2);
    color: var(--text-primary);
}

.alert-danger {
    background-color: rgba(220, 53, 69, 0.2);
    border-color: rgba(220, 53, 69, 0.3);
}

/* Fix badges */
.badge {
    color: white;
}

.badge-warning {
    background-color: #ffc107;
}

.badge-success {
    background-color: #28a745;
}

/* Fix existing images border */
.rounded.border {
    border-color: var(--border-color) !important;
}

/* Fix text colors */
.text-muted {
    color: var(--text-secondary) !important;
}

.text-danger {
    color: var(--danger-color) !important;
}

/* Fix form control plain text */
.form-control-plaintext {
    color: var(--text-primary) !important;
}

/* Fix form switch */
.form-switch .form-check-input {
    background-color: var(--surface-color);
    border-color: var(--border-color);
}

.form-switch .form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

/* Fix placeholder text */
::placeholder {
    color: var(--text-secondary) !important;
    opacity: 0.7 !important;
}

/* Fix existing image checkbox */
.existing-image .form-check-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* Fix disabled/readonly styling */
input:disabled,
textarea:disabled,
select:disabled,
input[readonly],
textarea[readonly] {
    background-color: var(--surface-color) !important;
    border-color: var(--border-color) !important;
    color: var(--text-secondary) !important;
    cursor: not-allowed !important;
}

/* Fix small text */
.small {
    color: var(--text-secondary);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const anonymousSwitch = document.getElementById('{{ form.is_anonymous.id }}');
    const contactInfoField = document.getElementById('{{ form.contact_info.id }}');
    
    // Function to toggle contact info field based on anonymity
    function toggleContactInfoField() {
        if (contactInfoField && anonymousSwitch) {
            if (anonymousSwitch.checked && "{{ report.report_type }}" === 'found') {
                // For found reports, if anonymous, contact info should be readonly
                contactInfoField.setAttribute('readonly', true);
                contactInfoField.classList.add('form-control-disabled');
            } else {
                // Otherwise, make it editable
                contactInfoField.removeAttribute('readonly');
                contactInfoField.classList.remove('form-control-disabled');
            }
        }
    }
    
    // Add event listener to anonymous switch
    if (anonymousSwitch) {
        anonymousSwitch.addEventListener('change', toggleContactInfoField);
    }
    
    // Initialize on page load
    toggleContactInfoField();
    
    // Add custom styling for disabled state
    const style = document.createElement('style');
    style.textContent = `
        .form-control-disabled {
            background-color: var(--surface-color) !important;
            cursor: not-allowed !important;
        }
        
        #{{ form.verification_question.id }}:disabled,
        #{{ form.is_anonymous.id }}:disabled {
            background-color: var(--surface-color) !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }
        
        /* Ensure form inputs have proper focus states in dark mode */
        .dark-theme .form-control:focus,
        .dark-theme .form-select:focus,
        .dark-theme input[type="datetime-local"]:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25) !important;
        }
    `;
    document.head.appendChild(style);
    
    // Update theme when theme changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                // Re-apply the style when theme changes
                style.textContent = style.textContent;
            }
        });
    });
    
    // Start observing the body for class changes
    observer.observe(document.body, { attributes: true });
});
</script>