{% extends 'layout.html' %}

{% block title %}Lost and Found{% endblock %}

{% block main %}
<div class="container py-5">
     <div class="text-start mb-3">
        <a href="{{ url_for('main.home') }}" class="btn btn-outline-secondary">
            ‚Üê Back to Home
        </a>
    </div>
    <div class="text-center mb-5">
        <h1 class="display-4">Lost and Found</h1>
    </div>
    <div class="row text-center mb-4">
        <div class="col-md-4">
            <button class="btn btn-outline-secondary btn-lg w-100 mb-3" id="report-items-button">Report Item</button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-outline-secondary btn-lg w-100 mb-3" id="lost-items-button">Browse Lost Items</button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-outline-secondary btn-lg w-100 mb-3" id="found-items-button">Browse Found Items</button>
        </div>
    </div>
    <div class="text-center" id="report-items-section" style="display: none">
        <div class="row justify-content-center text-center mt-4">
            <div class="d-flex justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h2 class="card-title text-center">Report Item</h2>
                            <!--
                            <form method="POST" action="{{ url_for('lost_and_found.report_item') }}" enctype="multipart/form-data">
                                {{ form.hidden_tag() }}
                                {% for subfield in form.report_type %}
                                    <div class="form-check">
                                        {{ subfield.label(class="form-check-label") }}
                                        {{ subfield(class="form-check-input") }}                                      
                                    </div>
                                {% endfor %}
                                <div class="form-check form-switch mb-3 mt-3">
                                    {{ form.is_anonymous(class="form-check-input", type="checkbox", role="switch") }}
                                    {{ form.is_anonymous.label(class="form-check-label") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.name.label(class="form-label") }}
                                    {{ form.name(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.description.label(class="form-label") }}
                                    {{ form.description(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.category_id.label(class="form-label") }}
                                    {{ form.category_id(class="form-select") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.location_id.label(class="form-label") }}
                                    {{ form.location_id(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.event_datetime.label(class="form-label") }}
                                    <input type="datetime-local" class="form-control" 
                                        id="{{ form.event_datetime.id }}" 
                                        name="{{ form.event_datetime.name }}" 
                                        value="{{ form.event_datetime.data.strftime('%Y-%m-%dT%H:%M') if form.event_datetime.data else '' }}">
                                </div>
                                <div class="mb-3">
                                    {{ form.images.label(class="form-label") }}
                                    {{ form.images(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.additional_details.label(class="form-label") }}
                                    {{ form.additional_details(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.contact_info.label(class="form-label") }}
                                    {{ form.contact_info(class="form-control") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  -->
    <div id="report-items"></div>
    <div class="text-center" id="lost-items-section" style="display: none">
        <div class="row justify-content-center text-center mt-4">
            <div class="d-flex justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div id="lost-items"></div>
                    <div class="text-center my-3">
  <button id="lost-load-more" class="btn btn-outline-primary">Load more</button>
</div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center" id="found-items-section" style="display: none">
        <div class="row justify-content-center text-center mt-4">
            <div class="d-flex justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div id="found-items"></div>
                    <div class="text-center my-3">
  <button id="found-load-more" class="btn btn-outline-primary">Load more</button>
</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
/* Simple "Load more" lazy loading for lost/found lists
   Uses: GET /lost_and_found/api?type=<lost|found>&page=<n>&page_size=<m>
*/

const PAGE_SIZE = 8; // change if you want more/less per "page"

const state = {
  lost: { page: 0, loading: false, finished: false },
  found: { page: 0, loading: false, finished: false },
};

// show/hide main sections: 'report', 'lost', 'found'
function toggleSections(show) {
  const sections = ['report', 'lost', 'found'];
  sections.forEach(section => {
    const el = document.getElementById(section + '-items-section');              
    if (!el) return;
    // show target, hide others
    el.style.display = (section === show) ? 'block' : 'none';
  });

  // If user opened the report section, scroll form into view
  if (show === 'report') {
    const form = document.querySelector('#report-items-section form');
    if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}


function createCardHTML(item) {
  // build same card structure you had before
  const imageUrl = (item.images && item.images.length > 0)
    ? item.images[0].image_url.replace(/^app\\/, "").replace(/\\/g, "/")
    : "{{ url_for('static', filename='images/default.png') }}";

  // Use template literal for markup
  return `
    <div class="card shadow-sm mb-3">
      <div class="row g-0 align-items-center">
        <div class="col-md-8">
          <div class="card-body">
            <h2 class="card-title fw-bold">${escapeHtml(item.name)}</h2>
            <p class="card-text">${escapeHtml((item.description || '').slice(0, 100))}${(item.description||'').length>100?'...':''}</p>
            <a class="btn btn-primary" href="/lost_and_found/item?id=${encodeURIComponent(item.id)}">See more</a>
          </div>
        </div>
        <div class="col-md-4">
          <img class="img-fluid rounded-end" alt="${escapeHtml(item.name)}" src="${imageUrl}">
        </div>
      </div>
    </div>
  `;
}

// Basic HTML-escaping to avoid injection when inserting user content
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

async function loadPage(type) {
  const s = state[type];
  if (s.loading || s.finished) return;
  s.loading = true;
  s.page += 1;

  const btn = document.getElementById(`${type}-load-more`);
  const originalBtnText = btn ? btn.innerHTML : '';
  if (btn) btn.innerHTML = 'Loading...';

  const url = `/lost_and_found/api?type=${encodeURIComponent(type)}&page=${s.page}&page_size=${PAGE_SIZE}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Network response was not ok');
    const data = await res.json();

    // support two shapes: { items: [...] } or an array
    const items = Array.isArray(data) ? data : (data.items || []);

    const container = document.getElementById(`${type}-items`);
    if (!container) throw new Error(`Missing container #${type}-items`);

    // If first page and no items -> show empty message
    if (s.page === 1 && items.length === 0) {
      container.innerHTML = `<div class="alert alert-info">No ${type} items found.</div>`;
    } else {
      // Append items
      const fragment = document.createDocumentFragment();
      items.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = createCardHTML(item);
        // append the card node (firstChild)
        fragment.appendChild(wrapper.firstElementChild);
      });
      container.appendChild(fragment);
    }

    // Decide if there are more pages
    if (data.has_more === false) {
      s.finished = true;
    } else if (typeof data.total === 'number') {
      const loaded = (s.page - 1) * PAGE_SIZE + items.length;
      if (loaded >= data.total) s.finished = true;
    } else {
      // fallback: if returned items < page_size -> assume last page
      if (items.length < PAGE_SIZE) s.finished = true;
    }

    // hide button if finished
    if (s.finished && btn) btn.style.display = 'none';
    if (!s.finished && btn) btn.style.display = 'inline-block';
  } catch (err) {
    console.error("Failed to load page:", err);
    // Optionally show a message in the container or use an alert
  } finally {
    s.loading = false;
    if (btn) btn.innerHTML = originalBtnText;
  }
}

// Initialize/Reset state and load first page when user opens a section
function openSection(type) {
  // show/hide sections using your existing toggleSections
  // our toggleSections expects 'report'|'lost'|'found'
  toggleSections(type === 'report' ? 'report' : type);

  // reset state when opening the section for the first time
  if (state[type].page === 0) {
    // clear old content
    const container = document.getElementById(`${type}-items`);
    if (container) container.innerHTML = '';
    const btn = document.getElementById(`${type}-load-more`);
    if (btn) {
      btn.style.display = 'inline-block';
      btn.innerHTML = 'Load more';
    }
    state[type].page = 0;
    state[type].finished = false;
    state[type].loading = false;
    // load first page
    loadPage(type);
  }
}

// wire up buttons and initial load (keeps your search param behavior)
document.addEventListener("DOMContentLoaded", function() {
  // handle query param to open section on page load
  const params = new URLSearchParams(window.location.search);
  const show = params.get('show');
  if (show === 'lost' || show === 'found' || show === 'report') {
    if (show === 'lost') openSection('lost');
    else if (show === 'found') openSection('found');
    else toggleSections('report');
  }

  // Buttons to open sections
  document.getElementById("report-items-button").addEventListener("click", function() {
    toggleSections('report');
  });

  document.getElementById("lost-items-button").addEventListener("click", function() {
    openSection('lost');
  });

  document.getElementById("found-items-button").addEventListener("click", function() {
    openSection('found');
  });

  // Load-more buttons
  const lostBtn = document.getElementById('lost-load-more');
  if (lostBtn) lostBtn.addEventListener('click', () => loadPage('lost'));

  const foundBtn = document.getElementById('found-load-more');
  if (foundBtn) foundBtn.addEventListener('click', () => loadPage('found'));
});
</script>


{% endblock %}
