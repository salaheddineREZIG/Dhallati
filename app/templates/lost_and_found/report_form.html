{% extends "layout.html" %}

{% block title %}Report Item - Lost & Found{% endblock %}

{% block extras %}
<style>
/* Simple, clean design */
body {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* BLACK & GOLD DARK THEME */
.dark-theme body {
    background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%) !important;
    color: #f8f8f8 !important;
}

.dark-theme .container {
    background: #111111 !important;
    border: 1px solid #333333 !important;
    color: #f8f8f8 !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
}

.dark-theme .card {
    background: #111111 !important;
    border: 1px solid #333333 !important;
    color: #f8f8f8 !important;
}

.dark-theme .card-header {
    background: linear-gradient(135deg, #000000, #222222) !important;
    color: #FFD700 !important;
    border-bottom: 1px solid #333333 !important;
}

.dark-theme .form-control,
.dark-theme .form-select,
.dark-theme .input-group-text {
    background-color: #222222 !important;
    border-color: #444444 !important;
    color: #f8f8f8 !important;
}

.dark-theme .form-control:focus,
.dark-theme .form-select:focus {
    background-color: #222222 !important;
    border-color: #FFD700 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25) !important;
    color: #f8f8f8 !important;
}

.dark-theme .form-text {
    color: #AAAAAA !important;
}

.dark-theme .text-muted {
    color: #AAAAAA !important;
}

.dark-theme .report-type-label {
    background: #222222 !important;
    border-color: #444444 !important;
    color: #f8f8f8 !important;
}

.dark-theme .report-type-label:hover {
    border-color: #FFD700 !important;
    background: rgba(255, 215, 0, 0.1) !important;
}

.dark-theme .report-type-option input[type="radio"]:checked + .report-type-label {
    background: rgba(255, 215, 0, 0.15) !important;
    border-color: #FFD700 !important;
    color: #FFD700 !important;
}

.dark-theme .file-upload-area {
    background: #222222 !important;
    border-color: #444444 !important;
    color: #f8f8f8 !important;
}

.dark-theme .file-upload-area:hover {
    background: rgba(255, 215, 0, 0.1) !important;
    border-color: #FFD700 !important;
}

.dark-theme .preview-image {
    border-color: #444444 !important;
    background: #333333 !important;
}

.dark-theme .alert-light {
    background-color: #222222 !important;
    border-left: 4px solid #FFD700 !important;
    color: #f8f8f8 !important;
}

.dark-theme .btn-secondary {
    background: #333333 !important;
    border-color: #444444 !important;
    color: #f8f8f8 !important;
}

.dark-theme .btn-secondary:hover {
    background: #444444 !important;
    border-color: #555555 !important;
}

.dark-theme .btn-primary {
    background: linear-gradient(135deg, #FFD700, #B8860B) !important;
    border: none !important;
    color: #000000 !important;
}

.dark-theme .btn-primary:hover {
    background: linear-gradient(135deg, #FFE55C, #FFD700) !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3) !important;
    color: #000000 !important;
}

.dark-theme .btn-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    border: none !important;
    color: #ffffff !important;
}

.dark-theme .btn-link {
    color: #AAAAAA !important;
}

.dark-theme .btn-link:hover {
    color: #FFD700 !important;
}

.dark-theme .navigation-buttons {
    background: #111111 !important;
    border-top: 1px solid #333333 !important;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5) !important;
}

.dark-theme .form-check-input {
    background-color: #222222 !important;
    border-color: #444444 !important;
}

.dark-theme .form-check-input:checked {
    background-color: #FFD700 !important;
    border-color: #FFD700 !important;
}

.dark-theme .progress {
    background: #222222 !important;
}

.dark-theme .progress-bar {
    background: linear-gradient(90deg, #FFD700, #B8860B) !important;
}

.dark-theme .alert-danger {
    background: rgba(220, 53, 69, 0.2) !important;
    border: 1px solid rgba(220, 53, 69, 0.3) !important;
    color: #fca5a5 !important;
}

.dark-theme .invalid-feedback {
    color: #fca5a5 !important;
}

.dark-theme input[type="datetime-local"] {
    background-color: #222222 !important;
    color-scheme: dark !important;
}

.dark-theme ::placeholder {
    color: #AAAAAA !important;
    opacity: 1 !important;
}

.dark-theme .datetime-clear-btn {
    color: #AAAAAA !important;
}

.dark-theme .datetime-clear-btn:hover {
    background-color: #333333 !important;
    color: #FFD700 !important;
}

.dark-theme .form-label {
    color: #f8f8f8 !important;
}

.dark-theme .form-label.fw-bold {
    color: #FFD700 !important;
}

.dark-theme .display-5 {
    color: #FFD700 !important;
}

.dark-theme .card-title {
    color: #FFD700 !important;
}

.dark-theme .datetime-icon svg {
    fill: #FFD700 !important;
}

.dark-theme .typewriter {
    border-right: 2px solid #FFD700 !important;
    animation: typing 1.5s steps(40, end), blink-caret 0.75s step-end infinite;
}

@keyframes blink-caret {
    from, to { border-color: transparent }
    50% { border-color: #FFD700; }
}

/* Fix for datetime input in dark mode - gold calendar icon */
.dark-theme input[type="datetime-local"] {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23FFD700' viewBox='0 0 16 16'%3E%3Cpath d='M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z'/%3E%3Cpath d='M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z'/%3E%3C/svg%3E");
}

.dark-theme .required-field::after {
    color: #ff6b6b !important;
}

.dark-theme .report-type-error,
.dark-theme .report-type-group.is-invalid .report-type-label {
    color: #ff6b6b !important;
    border-color: #ff6b6b !important;
}

.dark-theme .btn-outline-primary {
    color: #FFD700 !important;
    border-color: #FFD700 !important;
}

.dark-theme .btn-outline-primary:hover {
    background-color: #FFD700 !important;
    border-color: #FFD700 !important;
    color: #000000 !important;
}

/* Light theme styles remain the same */
.container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 30px;
    margin-bottom: 30px;
    padding: 30px;
}

.step {
    display: none;
}

.step.active {
    display: block;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Typewriter effect for headers */
.typewriter {
    overflow: hidden;
    border-right: 2px solid #3b82f6;
    white-space: nowrap;
    margin: 0 auto;
    animation: typing 1.5s steps(40, end), blink-caret 0.75s step-end infinite;
}

@keyframes typing {
    from { width: 0 }
    to { width: 100% }
}

/* Progress bar animation */
.progress-bar {
    background: linear-gradient(90deg, #3b82f6, #2563eb);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Navigation button improvements */
#cancel-btn:hover {
    background-color: #f8f9fa;
    border-color: #6c757d;
}

.navigation-buttons .btn {
    padding: 10px 20px;
    font-weight: 500;
}

/* Simple card design */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.card-header {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-radius: 12px 12px 0 0 !important;
    border: none;
}

/* Form styling */
.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 12px 15px;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.1);
}

/* Error states */
.form-control.is-invalid, .form-select.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.1);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
}

/* Report type buttons */
.report-type-group {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.report-type-option {
    flex: 1;
}

.report-type-option input[type="radio"] {
    display: none;
}

.report-type-label {
    display: block;
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.report-type-label:hover {
    border-color: #3b82f6;
    transform: translateY(-2px);
}

.report-type-option input[type="radio"]:checked + .report-type-label {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

/* Error state for report type */
.report-type-group.is-invalid .report-type-label {
    border-color: #dc3545;
}

.report-type-error {
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
    display: block;
}

/* Navigation buttons - always visible */
.navigation-buttons {
    position: sticky;
    bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    margin-top: 30px;
    z-index: 100;
}

.btn {
    border-radius: 8px;
    padding: 12px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
}

.btn-secondary {
    background: #6c757d;
    border: none;
}

/* Image upload */
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    border-color: #3b82f6;
    background: #f0f7ff;
}

.file-upload-area.is-invalid {
    border-color: #dc3545;
}

.image-preview-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid #e9ecef;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

/* Alert for form errors */
.alert-danger {
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    margin-bottom: 20px;
}

/* Custom datetime-local styling */
.datetime-input-group {
    position: relative;
}

.datetime-input-group .form-control[type="datetime-local"] {
    padding-right: 45px;
    cursor: pointer;
}

.datetime-input-group .datetime-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #3b82f6;
    pointer-events: none;
}

.datetime-input-group .form-control[type="datetime-local"]::-webkit-calendar-picker-indicator {
    background: transparent;
    bottom: 0;
    color: transparent;
    cursor: pointer;
    height: auto;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
    width: auto;
    opacity: 0;
}

.datetime-input-group .form-control[type="datetime-local"]:focus {
    background-color: #f0f7ff;
}

/* Date/time picker customization */
input[type="datetime-local"] {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%233b82f6' viewBox='0 0 16 16'%3E%3Cpath d='M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z'/%3E%3Cpath d='M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
}

/* Clear button for datetime input */
.datetime-clear-btn {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    font-size: 14px;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    display: none;
}

.datetime-clear-btn:hover {
    background-color: #f1f3f4;
    color: #dc3545;
}

.datetime-input-group:hover .datetime-clear-btn {
    display: block;
}

/* Timezone indicator */
.timezone-indicator {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 2px;
    margin-left: 5px;
}

/* Light blue backgrounds for focus states */
.form-control:focus, .form-select:focus {
    background-color: #f8fafc;
}

/* Review summary box */
.alert-light {
    background-color: #f0f7ff;
    border-left: 4px solid #3b82f6;
}

/* Blue theme adjustments */
.btn-outline-primary {
    color: #3b82f6;
    border-color: #3b82f6;
}

.btn-outline-primary:hover {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

/* Text colors for blue theme */
.text-primary {
    color: #2563eb !important;
}

.text-muted {
    color: #6b7280 !important;
}
/* main tag background color switches on theme */

.dark-theme main {
    background-color: #121212;
}
</style>
{% endblock %}
{% block main %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3 typewriter" style="color: #2c3e50;">
                    Report an Item
                </h1>
                <p class="text-muted fs-5">Help reunite lost items with their owners</p>
            </div>

            <!-- Form Level Errors -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Please correct the errors below:</strong>
                <ul class="mb-0 mt-2">
                    {% for field, errors in form.errors.items() %}
                        {% for error in errors %}
                            <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Progress Bar -->
            <div class="mb-5">
                <div class="progress" style="height: 8px; border-radius: 10px; background: #f1f3f4;">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" 
                         id="progress-bar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <small class="text-muted fw-bold">Basics</small>
                    <small class="text-muted fw-bold">Description</small>
                    <small class="text-muted fw-bold">Location</small>
                    <small class="text-muted fw-bold">Contact</small>
                </div>
            </div>

            <!-- Multi-Step Form -->
            <form id="reportForm" method="POST" action="{{ url_for('lost_and_found.report_item') }}" 
                enctype="multipart/form-data" novalidate>
                {{ form.csrf_token }}
                  
                <!-- Step 1: Basics -->
                <div class="step step-1 active">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Let's get started. What happened?</h5>
                        </div>
                        <div class="card-body">
                            <!-- Report Type -->
                            <div class="mb-4">
                                <label class="form-label fw-bold required-field">Report Type</label>
                                <div class="report-type-group {% if form.report_type.errors %}is-invalid{% endif %}">
                                    <div class="report-type-option">
                                        <input type="radio" name="report_type" id="lost" value="lost" required 
                                               {% if form.report_type.data == 'lost' %}checked{% endif %}>
                                        <label class="report-type-label" for="lost">
                                            I Lost an Item
                                        </label>
                                    </div>
                                    <div class="report-type-option">
                                        <input type="radio" name="report_type" id="found" value="found"
                                               {% if form.report_type.data == 'found' %}checked{% endif %}>
                                        <label class="report-type-label" for="found">
                                            I Found an Item
                                        </label>
                                    </div>
                                </div>
                                {% if form.report_type.errors %}
                                <div class="report-type-error">
                                    {% for error in form.report_type.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Anonymous - NOTE: Will be hidden for lost items via JavaScript -->
                            <div class="mb-4" id="anonymous-section">
                                <div class="form-check form-switch">
                                    {{ form.is_anonymous(class="form-check-input") }}
                                    <label class="form-check-label" for="is_anonymous">
                                        Post anonymously? (Your contact info will be available to the other party if you accept a claim)
                                    </label>
                                </div>
                                {% if form.is_anonymous.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.is_anonymous.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Category -->
                            <div class="mb-3">
                                <label for="category_id" class="form-label fw-bold required-field">Category</label>
                                {% if form.category_id.errors %}
                                    {{ form.category_id(class="form-select is-invalid") }}
                                {% else %}
                                    {{ form.category_id(class="form-select") }}
                                {% endif %}
                                {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Description -->
                <div class="step step-2">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Tell us about the item</h5>
                        </div>
                        <div class="card-body">
                            <!-- Item Name -->
                            <div class="mb-3">
                                <label for="name" class="form-label fw-bold required-field">Item Name</label>
                                {% if form.name.errors %}
                                    {{ form.name(class="form-control is-invalid", value=form.name.data or '') }}
                                {% else %}
                                    {{ form.name(class="form-control", value=form.name.data or '') }}
                                {% endif %}
                                <div class="form-text">Max 150 characters</div>
                                {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label for="description" class="form-label fw-bold">Description</label>
                                {% if form.description.errors %}
                                    {{ form.description(class="form-control is-invalid", rows="3") }}
                                {% else %}
                                    {{ form.description(class="form-control", rows="3") }}
                                {% endif %}
                                <div class="form-text">Max 150 characters</div>
                                {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Images -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Upload Images</label>
                                <div class="file-upload-area {% if form.images.errors %}is-invalid{% endif %}" id="file-upload-area">
                                    <p class="mb-2">Click to browse or drag & drop images</p>
                                    <small class="text-muted">Max 5 images (JPG, PNG, GIF)</small>
                                    {{ form.images(class="d-none", id="images") }}
                                </div>
                                <div id="image-preview" class="image-preview-container"></div>
                                {% if form.images.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.images.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Additional Details -->
                            <div class="mb-3">
                                <label for="additional_details" class="form-label">Additional Details</label>
                                {% if form.additional_details.errors %}
                                    {{ form.additional_details(class="form-control is-invalid", rows="2") }}
                                {% else %}
                                    {{ form.additional_details(class="form-control", rows="2") }}
                                {% endif %}
                                {% if form.additional_details.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.additional_details.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Location & Time -->
<div class="step step-3">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Where and when did this happen?</h5>
        </div>
        <div class="card-body">
            <!-- Location -->
            <div class="mb-3">
                <label for="location_id" class="form-label fw-bold">Location</label>
                {% if form.location_id.errors %}
                    {{ form.location_id(class="form-select is-invalid") }}
                {% else %}
                    {{ form.location_id(class="form-select") }}
                {% endif %}
                {% if form.location_id.errors %}
                <div class="invalid-feedback">
                    {% for error in form.location_id.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Specific Spot -->
            <div class="mb-3">
                <label for="specific_spot" class="form-label">Specific Spot</label>
                {% if form.specific_spot.errors %}
                    {{ form.specific_spot(class="form-control is-invalid", value=form.specific_spot.data or '') }}
                {% else %}
                    {{ form.specific_spot(class="form-control", value=form.specific_spot.data or '') }}
                {% endif %}
                <div class="form-text">e.g., 2nd floor study room</div>
                {% if form.specific_spot.errors %}
                <div class="invalid-feedback">
                    {% for error in form.specific_spot.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Event Date & Time - FIXED -->
            <div class="mb-3">
                <label for="event_datetime" class="form-label fw-bold">When did this happen?</label>
                <div class="datetime-input-group">
                    <input type="datetime-local" 
                           class="form-control {% if form.event_datetime.errors %}is-invalid{% endif %}" 
                           id="event_datetime" 
                           name="event_datetime"
                           step="60"
                           value="{% if form.event_datetime.data %}{{ form.event_datetime.data.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                    <span class="datetime-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z"/>
                            <path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                        </svg>
                    </span>
                    <button type="button" class="datetime-clear-btn" id="clear-datetime" title="Clear date/time">
                        ×
                    </button>
                </div>
                <div class="form-text d-flex justify-content-between">
                    <span>Optional - Leave empty for current date/time</span>
                    <span class="timezone-indicator">Timezone: Local</span>
                </div>
                {% if form.event_datetime.errors %}
                <div class="invalid-feedback">
                    {% for error in form.event_datetime.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

                <!-- Step 4: Contact -->
                <div class="step step-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Final Details</h5>
                        </div>
                        <div class="card-body">
                            <!-- Contact Info -->
                            <div class="mb-3">
                                <label for="contact_info" class="form-label fw-bold required-field">Contact Phone Number</label>
                                {% if form.contact_info.errors %}
                                    {{ form.contact_info(class="form-control is-invalid", value=form.contact_info.data or '') }}
                                {% else %}
                                    {{ form.contact_info(class="form-control", value=form.contact_info.data or '') }}
                                {% endif %}
                                <div class="form-text">10-digit number starting with 0 (e.g., 0698166666)</div>
                                {% if form.contact_info.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.contact_info.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Verification Question - Only for found items -->
                            <div class="mb-3" id="verification-question-section">
                                <label for="verification_question" class="form-label">Verification Question (For Found Items Only)</label>
                                {% if form.verification_question.errors %}
                                    {{ form.verification_question(class="form-control is-invalid", rows="3") }}
                                {% else %}
                                    {{ form.verification_question(class="form-control", rows="3") }}
                                {% endif %}
                                <div class="form-text">Optional: Question to help verify the real owner (e.g., "What color is the inside lining?")</div>
                                {% if form.verification_question.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.verification_question.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Review Summary -->
                            <div class="alert alert-light mt-4">
                                <h6 class="fw-bold mb-3">Review Your Report</h6>
                                <div id="review-summary">
                                    <div><strong>Type:</strong> <span id="review-type">Not set</span></div>
                                    <div><strong>Category:</strong> <span id="review-category">Not set</span></div>
                                    <div><strong>Item:</strong> <span id="review-item-name">Not set</span></div>
                                    <div><strong>Location:</strong> <span id="review-location">Not specified</span></div>
                                    <div><strong>Date & Time:</strong> <span id="review-datetime">Not specified</span></div>
                                    <div><strong>Anonymous:</strong> <span id="review-anonymous">No</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons - Always Visible -->
                <div class="navigation-buttons">
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-link text-muted me-3" id="cancel-btn">
                                Cancel
                            </button>
                            <button type="button" class="btn btn-secondary" id="prev-btn" style="display: none;">
                                ← Previous
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary" id="next-btn">
                                Continue →
                            </button>
                            <button type="submit" class="btn btn-success" id="submit-btn" style="display: none;">
                                Submit Report
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 4;
    const progressBar = document.getElementById('progress-bar');
    let formChanged = false;
    
    // Show/hide steps
    function showStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.querySelector(`.step-${step}`).classList.add('active');
        
        // Update buttons
        document.getElementById('prev-btn').style.display = step > 1 ? 'block' : 'none';
        document.getElementById('next-btn').style.display = step < totalSteps ? 'block' : 'none';
        document.getElementById('submit-btn').style.display = step === totalSteps ? 'block' : 'none';
        
        // Update progress
        const progress = ((step - 1) / (totalSteps - 1)) * 100;
        progressBar.style.width = progress + '%';
        
        // Update review summary when on last step
        if (step === totalSteps) {
            updateReviewSummary();
        }
    }
    
    // Update UI based on report type
    function updateFormUI() {
        const reportType = document.querySelector('input[name="report_type"]:checked');
        const anonymousSection = document.getElementById('anonymous-section');
        const verificationSection = document.getElementById('verification-question-section');
        
        if (reportType && reportType.value === 'lost') {
            // Hide anonymous checkbox for lost reports
            anonymousSection.style.display = 'none';
            // Uncheck anonymous if it was checked
            document.getElementById('is_anonymous').checked = false;
            // Update verification question label
            document.querySelector('label[for="verification_question"]').textContent = 
                'Verification Question (For Found Items Only)';
            verificationSection.style.display = 'block'; // Still show but with note
        } else if (reportType && reportType.value === 'found') {
            // Show anonymous checkbox for found reports
            anonymousSection.style.display = 'block';
            // Update verification question label
            document.querySelector('label[for="verification_question"]').textContent = 
                'Verification Question (Optional)';
            verificationSection.style.display = 'block';
        }
    }
    
    // Clear validation errors for a step
    function clearStepErrors(step) {
        const stepElement = document.querySelector(`.step-${step}`);
        stepElement.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
        stepElement.querySelectorAll('.invalid-feedback').forEach(el => {
            el.style.display = 'none';
        });
        stepElement.querySelectorAll('.report-type-error').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    // Show validation error for a specific field
    function showFieldError(field, message) {
        const formControl = field.closest('.form-control') || field.closest('.form-select') || field.closest('.report-type-group');
        if (formControl) {
            formControl.classList.add('is-invalid');
            
            // Create or show error message
            let errorElement = formControl.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('invalid-feedback')) {
                errorElement = document.createElement('div');
                errorElement.className = 'invalid-feedback';
                formControl.parentNode.insertBefore(errorElement, formControl.nextSibling);
            }
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    }

    // Cancel button functionality
    document.getElementById('cancel-btn').addEventListener('click', function() {
        if (formChanged) {
            const confirmCancel = confirm('You have unsaved changes. Are you sure you want to cancel?');
            if (confirmCancel) {
                window.location.href = "{{ url_for('lost_and_found.lost_and_found_page') }}";
            }
        } else {
            window.location.href = "{{ url_for('lost_and_found.lost_and_found_page') }}";
        }
    });
    
    // Track form changes
    const formInputs = document.querySelectorAll('#reportForm input, #reportForm textarea, #reportForm select');
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            formChanged = true;
        });
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });
    
    // Reset formChanged on submit
    document.getElementById('reportForm').addEventListener('submit', function() {
        formChanged = false;
    });
    
    // Warn user if they try to leave the page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return 'You have unsaved changes. Are you sure you want to leave?';
        }
    });
    
    // Validation
    function validateStep(step) {
        let isValid = true;
        clearStepErrors(step);
        
        switch(step) {
            case 1:
                const reportType = document.querySelector('input[name="report_type"]:checked');
                const category = document.getElementById('category_id');
                
                if (!reportType) {
                    showFieldError(document.querySelector('.report-type-group'), 'Please select a report type');
                    isValid = false;
                }
                if (!category.value) {
                    showFieldError(category, 'Please select a category');
                    isValid = false;
                }
                break;
                
            case 2:
                const itemName = document.getElementById('name');
                if (!itemName.value.trim()) {
                    showFieldError(itemName, 'Please enter an item name');
                    isValid = false;
                } else if (itemName.value.length > 150) {
                    showFieldError(itemName, 'Item name must be less than 150 characters');
                    isValid = false;
                }
                break;

            case 3:
    const eventDatetimeInput = document.getElementById('event_datetime');
    if (eventDatetimeInput.value) {
        const selectedDate = new Date(eventDatetimeInput.value);
        const now = new Date();
        const sevenDaysAgo = new Date(now);
        sevenDaysAgo.setDate(now.getDate() - 7);
        
        if (selectedDate > now) {
            showFieldError(eventDatetimeInput, 'Date cannot be in the future');
            isValid = false;
        } else if (selectedDate < sevenDaysAgo) {
            showFieldError(eventDatetimeInput, 'Date must be within the last 7 days');
            isValid = false;
        }
    }
    break;
                
            case 4:
                const contactInfo = document.getElementById('contact_info');
                const phoneRegex = /^0\d{9}$/;
                
                if (!contactInfo.value.trim()) {
                    showFieldError(contactInfo, 'Contact phone number is required');
                    isValid = false;
                } else if (!phoneRegex.test(contactInfo.value)) {
                    showFieldError(contactInfo, 'Please enter a valid 10-digit phone number starting with 0');
                    isValid = false;
                }
                break;
        }
        
        return isValid;
    }
    
    // Navigation
    document.getElementById('next-btn').addEventListener('click', function() {
        if (validateStep(currentStep)) {
            currentStep++;
            showStep(currentStep);
        }
    });
    
    document.getElementById('prev-btn').addEventListener('click', function() {
        currentStep--;
        showStep(currentStep);
    });
    
    // File upload
    const fileUploadArea = document.getElementById('file-upload-area');
    const imagesInput = document.getElementById('images');
    
    fileUploadArea.addEventListener('click', () => imagesInput.click());
    
    imagesInput.addEventListener('change', function(e) {
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        
        // Validate file count
        if (e.target.files.length > 5) {
            showFieldError(fileUploadArea, 'You can upload a maximum of 5 images');
            imagesInput.value = '';
            return;
        }
        
        for (let file of e.target.files) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        }
    });
    
    
    // Initialize datetime picker
    
    function initDateTimePicker() {
    const eventDatetimeInput = document.getElementById('event_datetime');
    const clearDatetimeBtn = document.getElementById('clear-datetime');
    
    // Only set default if empty
    if (!eventDatetimeInput.value) {
        const now = new Date();
        // Format to YYYY-MM-DDTHH:MM
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        eventDatetimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // Set min and max constraints (within last 7 days and not in the future)
    const now = new Date();
    const sevenDaysAgo = new Date(now);
    sevenDaysAgo.setDate(now.getDate() - 7);
    
    const formatForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    
    eventDatetimeInput.min = formatForInput(sevenDaysAgo);
    eventDatetimeInput.max = formatForInput(now);
    
    // Clear button functionality
    clearDatetimeBtn.addEventListener('click', function() {
        eventDatetimeInput.value = '';
        updateReviewSummary();
        clearDatetimeBtn.style.display = 'none';
    });
    
    // Show/hide clear button based on input value
    function updateClearButton() {
        clearDatetimeBtn.style.display = eventDatetimeInput.value ? 'block' : 'none';
    }
    
    eventDatetimeInput.addEventListener('input', function() {
        updateClearButton();
        updateReviewSummary();
    });
    
    // Initialize clear button visibility
    updateClearButton();
}

// Also update the formatDateTimeForDisplay function:
function formatDateTimeForDisplay(dateTimeString) {
    if (!dateTimeString) return 'Not specified';
    const date = new Date(dateTimeString);
    return date.toLocaleString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
    // Review summary
    function updateReviewSummary() {
        const reportType = document.querySelector('input[name="report_type"]:checked');
        const category = document.getElementById('category_id');
        const itemName = document.getElementById('name');
        const location = document.getElementById('location_id');
        const specificSpot = document.getElementById('specific_spot');
        const eventDatetime = document.getElementById('event_datetime');
        const isAnonymous = document.getElementById('is_anonymous');
        
        document.getElementById('review-type').textContent = 
            reportType ? (reportType.value === 'lost' ? 'Lost Item' : 'Found Item') : 'Not set';
        
        document.getElementById('review-category').textContent = 
            category.options[category.selectedIndex]?.text || 'Not set';
        
        document.getElementById('review-item-name').textContent = 
            itemName.value || 'Not set';
        
        let locationText = location.options[location.selectedIndex]?.text || 'Not specified';
        if (specificSpot.value) {
            locationText += ` (${specificSpot.value})`;
        }
        document.getElementById('review-location').textContent = locationText;
        
        document.getElementById('review-datetime').textContent = 
            formatDateTimeForDisplay(eventDatetime.value);
            
        document.getElementById('review-anonymous').textContent = 
            isAnonymous && isAnonymous.checked ? 'Yes' : 'No';
    }
    
    // Initialize
    document.querySelectorAll('input[name="report_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateFormUI();
            updateReviewSummary();
        });
    });
    
    // Initialize datetime picker
    initDateTimePicker();
    updateFormUI(); // Set initial UI state
    showStep(1);
});
</script>
{% endblock %}