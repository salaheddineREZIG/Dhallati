{% extends "layout.html" %}

{% block title %}Report Item - Lost & Found{% endblock %}

{% block extras %}
<style>
/* Simple, clean design */
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 30px;
    margin-bottom: 30px;
    padding: 30px;
}

.step {
    display: none;
}

.step.active {
    display: block;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Typewriter effect for headers */
.typewriter {
    overflow: hidden;
    border-right: 2px solid #667eea;
    white-space: nowrap;
    margin: 0 auto;
    animation: typing 1.5s steps(40, end), blink-caret 0.75s step-end infinite;
}

@keyframes typing {
    from { width: 0 }
    to { width: 100% }
}

@keyframes blink-caret {
    from, to { border-color: transparent }
    50% { border-color: #667eea; }
}

/* Progress bar animation */
.progress-bar {
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Simple card design */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.card-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px 12px 0 0 !important;
    border: none;
}

/* Form styling */
.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 12px 15px;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
}

/* Error states */
.form-control.is-invalid, .form-select.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.1);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
}

/* Report type buttons */
.report-type-group {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.report-type-option {
    flex: 1;
}

.report-type-option input[type="radio"] {
    display: none;
}

.report-type-label {
    display: block;
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.report-type-label:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.report-type-option input[type="radio"]:checked + .report-type-label {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

/* Error state for report type */
.report-type-group.is-invalid .report-type-label {
    border-color: #dc3545;
}

.report-type-error {
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
    display: block;
}

/* Navigation buttons - always visible */
.navigation-buttons {
    position: sticky;
    bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    margin-top: 30px;
    z-index: 100;
}

.btn {
    border-radius: 8px;
    padding: 12px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
}

.btn-secondary {
    background: #6c757d;
    border: none;
}

/* Image upload */
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.file-upload-area.is-invalid {
    border-color: #dc3545;
}

.image-preview-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid #e9ecef;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

/* Alert for form errors */
.alert-danger {
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block main %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3 typewriter" style="color: #2c3e50;">
                    Report an Item
                </h1>
                <p class="text-muted fs-5">Help reunite lost items with their owners</p>
            </div>

            <!-- Form Level Errors -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Please correct the errors below:</strong>
                <ul class="mb-0 mt-2">
                    {% for field, errors in form.errors.items() %}
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Progress Bar -->
            <div class="mb-5">
                <div class="progress" style="height: 8px; border-radius: 10px; background: #f1f3f4;">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" 
                         id="progress-bar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <small class="text-muted fw-bold">Basics</small>
                    <small class="text-muted fw-bold">Description</small>
                    <small class="text-muted fw-bold">Location</small>
                    <small class="text-muted fw-bold">Contact</small>
                </div>
            </div>

            <!-- Multi-Step Form -->
            <form id="reportForm" method="POST" action="{{ url_for('lost_and_found.report_item') }}" 
                enctype="multipart/form-data" novalidate>
                {{ form.csrf_token }} 
                  
                <!-- Step 1: Basics -->
                <div class="step step-1 active">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Let's get started. What happened?</h5>
                        </div>
                        <div class="card-body">
                            <!-- Report Type -->
                            <div class="mb-4">
                                <label class="form-label fw-bold required-field">Report Type</label>
                                <div class="report-type-group {% if form.report_type.errors %}is-invalid{% endif %}">
                                    <div class="report-type-option">
                                        <input type="radio" name="report_type" id="lost" value="lost" required 
                                               {% if form.report_type.data == 'lost' %}checked{% endif %}>
                                        <label class="report-type-label" for="lost">
                                            I Lost an Item
                                        </label>
                                    </div>
                                    <div class="report-type-option">
                                        <input type="radio" name="report_type" id="found" value="found"
                                               {% if form.report_type.data == 'found' %}checked{% endif %}>
                                        <label class="report-type-label" for="found">
                                            I Found an Item
                                        </label>
                                    </div>
                                </div>
                                {% if form.report_type.errors %}
                                <div class="report-type-error">
                                    {% for error in form.report_type.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Anonymous -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    {{ form.is_anonymous(class="form-check-input") }}
                                    <label class="form-check-label" for="is_anonymous">
                                        Post anonymously?
                                    </label>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="mb-3">
                                <label for="category_id" class="form-label fw-bold required-field">Category</label>
                                {% if form.category_id.errors %}
                                    {{ form.category_id(class="form-select is-invalid") }}
                                {% else %}
                                    {{ form.category_id(class="form-select") }}
                                {% endif %}
                                {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Description -->
                <div class="step step-2">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Tell us about the item</h5>
                        </div>
                        <div class="card-body">
                            <!-- Item Name -->
                            <div class="mb-3">
                                <label for="name" class="form-label fw-bold required-field">Item Name</label>
                                {% if form.name.errors %}
                                    {{ form.name(class="form-control is-invalid", value=form.name.data or '') }}
                                {% else %}
                                    {{ form.name(class="form-control", value=form.name.data or '') }}
                                {% endif %}
                                <div class="form-text">Max 150 characters</div>
                                {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label for="description" class="form-label fw-bold">Description</label>
                                {% if form.description.errors %}
                                    {{ form.description(class="form-control is-invalid", rows="3") }}
                                {% else %}
                                    {{ form.description(class="form-control", rows="3") }}
                                {% endif %}
                                <div class="form-text">Max 150 characters</div>
                                {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Images -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Upload Images</label>
                                <div class="file-upload-area {% if form.images.errors %}is-invalid{% endif %}" id="file-upload-area">
                                    <p class="mb-2">Click to browse or drag & drop images</p>
                                    <small class="text-muted">Max 5 images (JPG, PNG, GIF)</small>
                                    {{ form.images(class="d-none", id="images") }}
                                </div>
                                <div id="image-preview" class="image-preview-container"></div>
                                {% if form.images.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.images.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Additional Details -->
                            <div class="mb-3">
                                <label for="additional_details" class="form-label">Additional Details</label>
                                {% if form.additional_details.errors %}
                                    {{ form.additional_details(class="form-control is-invalid", rows="2") }}
                                {% else %}
                                    {{ form.additional_details(class="form-control", rows="2") }}
                                {% endif %}
                                {% if form.additional_details.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.additional_details.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Location & Time -->
                <div class="step step-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Where and when did this happen?</h5>
                        </div>
                        <div class="card-body">
                            <!-- Location -->
                            <div class="mb-3">
                                <label for="location_id" class="form-label fw-bold">Location</label>
                                {% if form.location_id.errors %}
                                    {{ form.location_id(class="form-select is-invalid") }}
                                {% else %}
                                    {{ form.location_id(class="form-select") }}
                                {% endif %}
                                {% if form.location_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.location_id.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Specific Spot -->
                            <div class="mb-3">
                                <label for="specific_spot" class="form-label">Specific Spot</label>
                                {% if form.specific_spot.errors %}
                                    {{ form.specific_spot(class="form-control is-invalid", value=form.specific_spot.data or '') }}
                                {% else %}
                                    {{ form.specific_spot(class="form-control", value=form.specific_spot.data or '') }}
                                {% endif %}
                                <div class="form-text">e.g., 2nd floor study room</div>
                                {% if form.specific_spot.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.specific_spot.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Event Date & Time -->
                            <div class="mb-3">
                                <label for="event_datetime" class="form-label fw-bold">When did this happen?</label>
                                {% if form.event_datetime.errors %}
                                    {{ form.event_datetime(class="form-control is-invalid") }}
                                {% else %}
                                    {{ form.event_datetime(class="form-control") }}
                                {% endif %}
                                <div class="form-text">Leave empty for current date/time</div>
                                {% if form.event_datetime.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.event_datetime.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Contact -->
                <div class="step step-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Final Details</h5>
                        </div>
                        <div class="card-body">
                            <!-- Contact Info -->
                            <div class="mb-3">
                                <label for="contact_info" class="form-label fw-bold required-field">Contact Phone</label>
                                {% if form.contact_info.errors %}
                                    {{ form.contact_info(class="form-control is-invalid", value=form.contact_info.data or '') }}
                                {% else %}
                                    {{ form.contact_info(class="form-control", value=form.contact_info.data or '') }}
                                {% endif %}
                                <div class="form-text">10-digit number starting with 0</div>
                                {% if form.contact_info.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.contact_info.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Verification Question -->
                            <div class="mb-3" id="verification-question-section" style="display: none;">
                                <label for="verification_question" class="form-label fw-bold">Verification Question</label>
                                {% if form.verification_question.errors %}
                                    {{ form.verification_question(class="form-control is-invalid", rows="3") }}
                                {% else %}
                                    {{ form.verification_question(class="form-control", rows="3") }}
                                {% endif %}
                                <div class="form-text">Required for found items - helps verify the real owner</div>
                                {% if form.verification_question.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.verification_question.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Review Summary -->
                            <div class="alert alert-light mt-4">
                                <h6 class="fw-bold mb-3">Review Your Report</h6>
                                <div id="review-summary">
                                    <div><strong>Type:</strong> <span id="review-type">Not set</span></div>
                                    <div><strong>Category:</strong> <span id="review-category">Not set</span></div>
                                    <div><strong>Item:</strong> <span id="review-item-name">Not set</span></div>
                                    <div><strong>Location:</strong> <span id="review-location">Not specified</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons - Always Visible -->
                <div class="navigation-buttons">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="prev-btn" style="display: none;">
                            ← Previous
                        </button>
                        <button type="button" class="btn btn-primary ms-auto" id="next-btn">
                            Continue →
                        </button>
                        <button type="submit" class="btn btn-success ms-auto" id="submit-btn" style="display: none;">
                            Submit Report
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 4;
    const progressBar = document.getElementById('progress-bar');
    
    // Show/hide steps
    function showStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.querySelector(`.step-${step}`).classList.add('active');
        
        // Update buttons
        document.getElementById('prev-btn').style.display = step > 1 ? 'block' : 'none';
        document.getElementById('next-btn').style.display = step < totalSteps ? 'block' : 'none';
        document.getElementById('submit-btn').style.display = step === totalSteps ? 'block' : 'none';
        
        // Update progress
        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        progressBar.style.width = progress + '%';
        
        updateReviewSummary();
    }
    
    // Clear validation errors for a step
    function clearStepErrors(step) {
        const stepElement = document.querySelector(`.step-${step}`);
        stepElement.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
        stepElement.querySelectorAll('.invalid-feedback').forEach(el => {
            el.style.display = 'none';
        });
        stepElement.querySelectorAll('.report-type-error').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    // Show validation error for a specific field
    function showFieldError(field, message) {
        const formControl = field.closest('.form-control') || field.closest('.form-select') || field.closest('.report-type-group');
        if (formControl) {
            formControl.classList.add('is-invalid');
            
            // Create or show error message
            let errorElement = formControl.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('invalid-feedback')) {
                errorElement = document.createElement('div');
                errorElement.className = 'invalid-feedback';
                formControl.parentNode.insertBefore(errorElement, formControl.nextSibling);
            }
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    }
    
    // Validation
    function validateStep(step) {
        let isValid = true;
        clearStepErrors(step);
        
        switch(step) {
            case 1:
                const reportType = document.querySelector('input[name="report_type"]:checked');
                const category = document.getElementById('category_id');
                
                if (!reportType) {
                    showFieldError(document.querySelector('.report-type-group'), 'Please select a report type');
                    isValid = false;
                }
                if (!category.value) {
                    showFieldError(category, 'Please select a category');
                    isValid = false;
                }
                break;
                
            case 2:
                const itemName = document.getElementById('name');
                if (!itemName.value.trim()) {
                    showFieldError(itemName, 'Please enter an item name');
                    isValid = false;
                }
                break;
                
            case 4:
                const contactInfo = document.getElementById('contact_info');
                const phoneRegex = /^0\d{9}$/;
                if (!phoneRegex.test(contactInfo.value)) {
                    showFieldError(contactInfo, 'Please enter a valid 10-digit phone number starting with 0');
                    isValid = false;
                }
                
                // Validate verification question for found items
                const reportTypeCheck = document.querySelector('input[name="report_type"]:checked');
                if (reportTypeCheck && reportTypeCheck.value === 'found') {
                    const verificationQuestion = document.getElementById('verification_question');
                    if (!verificationQuestion.value.trim()) {
                        showFieldError(verificationQuestion, 'Please provide a verification question for found items');
                        isValid = false;
                    }
                }
                break;
        }
        
        return isValid;
    }
    
    // Navigation
    document.getElementById('next-btn').addEventListener('click', function() {
        if (validateStep(currentStep)) {
            currentStep++;
            showStep(currentStep);
        }
    });
    
    document.getElementById('prev-btn').addEventListener('click', function() {
        currentStep--;
        showStep(currentStep);
    });
    
    // Toggle verification question
    function toggleVerificationQuestion() {
        const reportType = document.querySelector('input[name="report_type"]:checked');
        const verificationSection = document.getElementById('verification-question-section');
        
        if (reportType && reportType.value === 'found') {
            verificationSection.style.display = 'block';
        } else {
            verificationSection.style.display = 'none';
        }
    }
    
    // File upload
    const fileUploadArea = document.getElementById('file-upload-area');
    const imagesInput = document.getElementById('images');
    
    fileUploadArea.addEventListener('click', () => imagesInput.click());
    
    imagesInput.addEventListener('change', function(e) {
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        
        for (let file of e.target.files) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        }
    });
    
    // Review summary
    function updateReviewSummary() {
        if (currentStep === 4) {
            const reportType = document.querySelector('input[name="report_type"]:checked');
            const category = document.getElementById('category_id');
            const itemName = document.getElementById('name');
            const location = document.getElementById('location_id');
            const specificSpot = document.getElementById('specific_spot');
            
            document.getElementById('review-type').textContent = 
                reportType ? (reportType.value === 'lost' ? 'Lost Item' : 'Found Item') : 'Not set';
            
            document.getElementById('review-category').textContent = 
                category.options[category.selectedIndex]?.text || 'Not set';
            
            document.getElementById('review-item-name').textContent = 
                itemName.value || 'Not set';
            
            let locationText = location.options[location.selectedIndex]?.text || 'Not specified';
            if (specificSpot.value) {
                locationText += ` (${specificSpot.value})`;
            }
            document.getElementById('review-location').textContent = locationText;
        }
    }
    
    // Initialize
    document.querySelectorAll('input[name="report_type"]').forEach(radio => {
        radio.addEventListener('change', toggleVerificationQuestion);
    });
    
    // Set current datetime as default
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('event_datetime').value = now.toISOString().slice(0, 16);
    
    showStep(1);
});
</script>
{% endblock %}